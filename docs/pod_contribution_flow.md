# 🧩 AI-Native Delivery: Pod Patch Contribution Flow

This document outlines the standardized process for ChatGPT Pods to contribute work into the shared GitHub repository using patches, ensuring human-in-the-loop review, traceability, and automation-friendly tooling.

---

## 🌟 Purpose
Enable any Pod to:
- Finalize an output collaboratively with a human
- Generate a patch representing the change
- Attach metadata for automation and traceability
- Let the human apply, push, and open a PR for review

---

## ♻️ Contribution Flow

### Step 1: Finalize Output in Chat
- Human + Pod iterate on an output file (e.g., markdown, Python, YAML)
- When final, the human signals the Pod to generate a patch

### Step 2: Generate Patch via Tool
- Pod uses `generate_patch.py` to:
  - Detect staged file changes
  - Create a patch in `.patches/patch_<timestamp>_<task_id>.diff`
  - Output metadata:
    ```json
    {
      "patch_file": ".patches/patch_20250422_103045_2.3_build_metrics_tool.diff",
      "task_id": "2.3_build_metrics_tool",
      "summary": "Added metrics tracker logic",
      "output_folders": ["docs/", "metrics/"]
    }
    ```
  - Save metadata to `.logs/patches/<patch_id>.json`

> ⚠️ **Note:** Since ChatGPT cannot access or clone the repo directly, it determines file destinations using the `outputs` field in `task.yaml`. These serve as hints about where the human should place the generated content, and help structure metadata for patch creation.

### Step 3: Human Promotes Patch
- Human downloads patch from ChatGPT sandbox
- Runs `promote_patch.sh`, which:
  - Moves patch to `.patches/`
  - Calls `create_pr_from_patch.sh` to:
    - Create a new branch
    - Apply the patch
    - Commit and push to GitHub
    - Open a Pull Request (PR) with patch summary

### Step 4: PR Review
- Human reviews and approves the PR
- PR is merged into `main`

---

## 🛠️ Supporting Scripts and Tools

### ✅ `generate_patch.py`
- Stages changes, generates `.diff`, and writes metadata
- Inputs: task ID, optional output folders, summary
- Output: `.patches/*.diff` and `.logs/patches/*.json`
- Uses the `outputs` path from `task.yaml` to infer expected destination folders

### ✅ `create_pr_from_patch.sh`
- Applies the patch to a new Git branch
- Commits, pushes, and opens a PR
- Can be run directly or via wrapper script

### ✅ `promote_patch.sh` (wrapper)
- Orchestrates both patch move and PR creation
- Reads latest patch metadata and simplifies workflow

---

## 📁 Directory Conventions

| Folder | Purpose |
|--------|---------|
| `.patches/` | Stores all patch files generated by pods |
| `.logs/patches/` | Metadata for each patch (task ID, summary, output folders) |
| `.logs/trace_log.md` | Chronological log of applied patches |
| `metrics/metrics.yaml` | Tracks delivery metrics per patch/task |

---

## 📌 Custom GPT Action: `promote_patch`

A tool that can be called by a ChatGPT Pod when a task output is finalized. It:
- Generates a patch using staged changes
- Returns metadata needed for patch promotion and review

**Input Parameters:**
```json
{
  "task_id": "string",
  "output_folders": ["string"],
  "summary": "string"
}
```

**Returns:**
```json
{
  "patch_file": "string",
  "task_id": "string",
  "summary": "string",
  "output_folders": ["string"]
}
```

Used as the final step in the Pod output generation to signal a human to run local promotion. The `output_folders` are derived from `task.yaml.outputs` and serve as guidance.

---

## 📌 Benefits
- Structured and traceable contributions
- Human-reviewed before merge
- Aligned with sandbox constraints of ChatGPT
- Automatable across pods and phases

---

Let’s use this standardized process to keep our delivery loop fast, safe, and trackable across all Pods 🚀

